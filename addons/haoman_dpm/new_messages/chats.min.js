$(function () {
    $("body").scrollTop($("#wall_window")[0].scrollHeight);
    isOpened = true;
    MsgLoader.create();
    $("#input_text").keydown(function (e) {
        if (e.keyCode == 13) {
            $("#send_btn").click()
        }
    });
    $("#send_btn").click(function () {
        if (1 == isback)
        {
            $.tip("您已经被禁言");
            return;
        }
        var i = $("#input_text").val();

        if(!keyWord.check(i)){
            $("#input_text").val('')
            return $.tip('请勿发布广告等不适内容');
        }

        //敏感词
        i = keyWord.replace(i);

        if ("" == $.trim(i)) {
            $.tip("信息为空");
            return;
            $.showLoading("发送中..")
        }

        MagSender.sendText(i);
        $("#input_text").val("");
        $(".msg_input").removeClass("showing_face").removeClass("showing_menu");
        $(".msg_list_ctx").css("padding-bottom", "4rem");
        var e = $(".msg_list_ctx").outerHeight();
        $.hideLoading();
        $("body").scrollTop(e)
    });
    // $(".msg_input_menu .photo_file").upload_image(function (e) {
    //     $.hideLoading();
    //     // console.log(e);
    //     MagSender.sendImage(e)
    // });
    $(".menu_btn").click(function () {
        if ($(".msg_input").removeClass("showing_face").toggleClass("showing_menu").hasClass("showing_menu")) {
            $(".msg_list_ctx").css("padding-bottom", "12rem")
        } else {
            $;
            $(".msg_list_ctx").css("padding-bottom", "4rem")
        }
    });
    $(".smile_btn").click(function () {
        if ($(".msg_input").removeClass("showing_menu").toggleClass("showing_face").hasClass("showing_face")) {
            $(".msg_list_ctx").css("padding-bottom", "16rem")
        } else {
            $(".msg_list_ctx").css("padding-bottom", "4rem")
        }
    });
    $("#emoji-gallery .e1").click(function () {
        $("#input_text").val($("#input_text").val() + emojione.unifyUnicode($(this).attr("data-shortname")));
        $("#input_text").scrollLeft(99999)
    });
    $(".msg_input_box").focus(function () {
        setTimeout(function () {
            $(".msg_input").addClass("active");
            $(window).scrollTop(9e3)
        }, 300)
    }).focusout(function () {
        $(".msg_input").removeClass("active")
    });
    $(document).on("click", ".openredpack", function () {
        $.post(go_RedPackStatus + "&id="+$(this).attr("data-id"), function (e) {

            if (e.follow == 1) {
                t = '<div class="mzh_modal_alert_dialog" style="background-color:#fff;box-shadow:none;">';
                t += '<span class="am-icon-close iconfont icon-guanbi close"></span>';
                t += '<img width="100%" src="'+e.img+'">';
                t += '<p style="background: #fff;padding: 0 2rem 01rem;">请关注“'+e.accountname+'”确保你抢到的红包顺利提现</p>';
                t += "</div>";
                $("#redbox").html(t);
                $("#redbox").show();
                return
            }
            var t = "";
            t += '<p><img src="' + e.avatar + '" class="avatar" ></p>';
            t += '<p class="nickname">' + e.nickname + "的红包</p>";
            t += '<p class="hb_ctx">' + e.content + "</p>";
            if (e.logRst) {
                t += '<p class="money"><span>￥</span>' + e.primary_money + "</p>";
                t += '<p class="show_log" data-id="' + e.id + '">看看大家手气</p>';
                t += '<p class="hbb_tip">红包金额可从“账户余额”中提现到您的微信零钱</p>'
            } else {
                if (e.getOneLog) {
                    t += '<p class="money"><span>红包已派完</span></p>';
                    t += '<p class="show_log" data-id="' + e.id + '">看看大家手气</p>'
                } else if (e.is_end) {
                    t += '<p class="money"><span>'+e.msg+'</span></p>'
                } else {
                    t += '<p class="open_btn_p"><span data-id="' + e.id + '" class="open_btn"></span></p>'
                }
            }
            $("#redcontent").html(t);
            $(".hb_panel").show();
            $("#redbox").show()
        },"json")
    });
    $(document).on("click", ".open_btn", function () {
        $.showLoading("打开中..");
        redpackid = $(this).attr("data-id");

        $.post(go_RedPackStatus+"&token=2&id=" + redpackid, function (e) {
            $.hideLoading();
            if (e.code == "1") {
                var t = "";
                t += '<p class="money"><span>￥</span>' + e.msg + "</p>";
                t += '<p class="show_log" data-id="' + redpackid + '">看看大家手气</p>';
                t += '<p class="hbb_tip">红包金额可从“账户余额”中提现到您的微信零钱</p>';
                $(".open_btn_p").hide();
                $(".open_btn_p").before(t)
            } else {
                $.tip(e.msg)
            }
        },"json")
    });
    $(document).on("click", "#redbox .icon-guanbi", function () {
        $("#redbox").hide();
        $("#redluck").hide()
    });
    $(document).on("click", ".hbb_tip", function () {
        location.href=go_tx;
    });
    $(document).on("click", ".show_log", function () {
        $.post(go_RedPackLuck+"&id=" + $(this).attr("data-id"), function (e) {
            if (e.logRst) {
                var t = "";
                for (var s = 0; s < e.logRst.length; s++) {
                    t += '<li><div class="avatar" style="background-image: url(' + e.logRst[s].avatar + ')">';
                    if (e.logRst[s].isBestUser) {
                        t += '<img src="../addons/haoman_dpm/imgs/bestone.png" width="30%" style="position: absolute;margin-top:8%;margin-left:45%;">'
                    }
                    t += '</div><p><span class="nickname">' + e.logRst[s].nickname + '</span><span class="money">' + e.logRst[s].credit + "元</span></p>";
                    t += '<p class="time">' + e.logRst[s].createtime + "</p></li>"
                }
                $("#redluck").show();
                $(".hb_panel").hide();
                $(".hb_logs ul").html(t)
            } else {
                $.tip(e.msg)
            }
        },"json")
    });
    $(document).on("click", ".msg_ctx_image", function () {
        if ($(this).attr("data-url")) {
            var e = document.getElementById("perform_video");
            e.src = $(this).attr("data-url");
            e.type = $(this).attr("data-type");
            e.poster = $(this).attr("_src");
            $(".show_video_msg_box").fadeIn()
        } else {
            $(".show_img_msg_box").fadeIn().find("img").attr("src", $(this).attr("_src"))
        }
    });
    $(".show_img_msg_box, .show_video_msg_box").click(function () {
        $(".show_img_msg_box").find("img").attr("src", "");
        var e = document.getElementById("perform_video");
        e.src = "";
        e.pause();
        $(this).fadeOut()
    });
    $(document).on("click", ".icon-zhongxin", function () {
        $.showLoading("信息同步中..");
        $.post(go_syncinfo, function (e) {
            $.hideLoading();
            // $.tip(e.msg);
            // console.log(e.msg);

            if (e.code ==2) {
                $.tip(e.msg);
                location.reload()
            } else if (e.code == 1 ) {
                $.tip(e.msg);
            } else {
                $.tip(e.msg)
            }
        }, "json")
    });
    window.onload = function () {
    };
    $(".wall_menu_el").click(function () {
        if (1 == isback)
        {
            $.tip("您已经被禁言");
            return;
        }
        if (0 == is_Opened) {
            $.tip("大屏幕尚未开启~<br>如检测有误请刷新您的手机页面或更换网络环境重试")
        } else {
            $(window).attr("location", $(this).attr("data-href"))
        }
    });
    $(".wall_menu_sl").click(function () {

        if (is_Opened == 0) {
            $.tip("大屏幕尚未开启~<br>如检测有误请刷新您的手机页面或更换网络环境重试")
        } else {
            $(window).attr("location", $(this).attr("data-href"))
        }
    });
    $(".wall_menu_mf").click(function () {
        if (is_Opened == 0) {
            $.tip("大屏幕尚未开启~<br>如检测有误请刷新您的手机页面或更换网络环境重试")
        } else {
            $(window).attr("location", $(this).attr("data-href"))
        }
    });
    $(".msg_list").on("click", ".del_btn", function () {
        var e = $(this).attr("msgid");
        var t = [
        //     {
        //     text: "<span class='icon iconfont icon-shanchu'></span> 标记为轰炸信息", onClick: function () {
        //         $.getJSON("/admin/wap.customer/delLajiMsg?id=" + e, function (e) {
        //             $.alert(e.msg, "", function () {
        //                 location.reload()
        //             })
        //         })
        //     }
        // },
            {
            text: "<span class='icon iconfont icon-shanchu'></span> 删除信息", onClick: function () {
                $.getJSON(go_deletemsg +"&msgid="+e, function (e) {
                    $.alert(e.msg, "",function () {
                        MsgLoader.deleteMsgbox(e.id);
                    });

                    })

            }
        },
            {
            text: "<span class='icon iconfont icon-empty'></span> 清空Ta发言", onClick: function () {
                var t = MsgList[e];
                $.getJSON(go_deletemsg+"&fid=" + t["from_user"], function (e) {
                    $.alert(e.msg, "", function () {
                        location.reload()
                    })
                })
            }
        },
        //     {
        //     text: "<span class='icon iconfont icon-jinyandisc'></span> 禁言30分钟",
        //     className: "color-danger",
        //     onClick: function () {
        //         var t = MsgList[e];
        //         $.getJSON("/admin/wap.customer/blackTalk?uid=" + t["uid"] + "&time=30", function (e) {
        //             $.alert(e.msg, "")
        //         })
        //     }
        // },
        //     {
        //     text: "<span class='icon iconfont icon-jinyandisc'></span> 禁言24小时",
        //     className: "color-danger",
        //     onClick: function () {
        //         var t = MsgList[e];
        //         $.getJSON("/admin/wap.customer/blackTalk?uid=" + t["uid"] + "&time=24", function (e) {
        //             $.alert(e.msg, "")
        //         })
        //     }
        // },
        //     {
        //     text: "<span class='icon iconfont icon-w'></span> 解除禁言", className: "color-danger", onClick: function () {
        //         var t = MsgList[e];
        //         $.getJSON("/admin/wap.customer/blackTalk?uid=" + t["uid"] + "&time=-1", function (e) {
        //             $.alert(e.msg, "")
        //         })
        //     }
        // },
            {
            text: "<span class='icon iconfont icon-heimingdan'></span> 加入黑名单",
            className: "color-danger",
            onClick: function () {
                var t = MsgList[e];
                $.getJSON(go_pullblack+"&userid=" + t["from_user"] + "&act=1", function (e) {
                    $.alert(e.msg, "")
                })
            }
        },
            {
            text: "<span class='icon iconfont icon-jiechuheimingdan'></span> 解除黑名单",
            className: "color-danger",
            onClick: function () {
                var t = MsgList[e];
                $.getJSON(go_pullblack+"&userid=" + t["from_user"] + "&act=0", function (e) {
                    $.alert(e.msg, "")
                })
            }
        }];
        // if (MsgList[e].type == "bp" || MsgList[e].type == "ds" || MsgList[e].type == "el" || MsgList[e].type == "ap") {
        //     t.push({
        //         text: "<span class='icon iconfont icon-zhongxin'></span> 重新显示霸屏",
        //         className: "color-danger",
        //         onClick: function () {
        //             $.getJSON("/admin/wap.customer/reshow?id=" + e, function (e) {
        //                 $.alert(e.msg, "")
        //             })
        //         }
        //     })
        // }
        $.actions({actions: t})
    });
    $("#wall_window").click(function () {
        $(".msg_input").removeClass("showing_face").removeClass("showing_menu");
        $(".msg_list_ctx").css("padding-bottom", "4rem")
    });
    var e = false;
    $(window).scroll(t);
    function t(e) {
        var t = $(this).scrollTop();
        if (t < 200) {
            if ($(".top_loadmore") != null) {
                MsgLoader.loadmore()
            }
        }
    }
});
var MagSender = {
    lasttime: 0, sending: false, send: function (e, t, s) {
        t.type = e;
        var i = "";
        $.showLoading("发送中..");
        if (e === "base") {
            i = go_sendmsg
        }else if(e === "rp"){
            i= go_Confirm_dpmhb
        }else if(e === "ds"){
            i= go_Confirm_dpmds
        } else {
            i = go_Confirm_bp
        }
        $.post(i, t, function (e) {
            MsgLoader.loadmsg(false);
            $.hideLoading();

           if(e.success == 100){
               $.tip(e.msg);
               return;
           }else if(e.success == 2){
               $.tip(e.msg);
               setTimeout(function () {
                   location.reload()
               },2000)

               return;
           }
            if (e.code !== 10&&e.code!=8) {
                if (e.code == 2) {
                    location.href =go_pay+'&orderid='+e.orderid+'&pay_type='+e.pay_type;

                    return
                }
                // $.tip(e.msg);
                if (e.code == 1) {

                    $("#popup_bp").removeClass('weui-popup__container--visible');
                    var result = e.arr;
                    $(".otitle").empty().append(result.xq);

                    $(".ordersn").empty().append(result.ordersn);

                    $(".shangjia").empty().append(result.title);

                    $(".jine").empty().append(result.fee);

                    $("input[name='params']").val(e.params);
                    $("#biaodan").submit();
//                    $("#wBtn").click();
                }
                if (e.code === 0) {
                    location.reload()
                }
            } else {

                if (s) s(e)
            }
        },'json')
    }, sendText: function (e) {
        this.send("base", {content: e}, function (e) {
            if (e.code == 8) {
                $.tip(e.msg)
            }
            $("#input_text").val("")
        })
    }, sendImage: function (e) {
        this.send("base", {image: e})
    }, sendItem: function (e, t) {
        this.send(t, e, function (e) {
            MsgLoader.loading_msg = true;
                $.tip(e.msg)

            // location.href = "/payment/index?pid=" + e.oid
        })
    }
};
var MsgLoader = {
    loading_msg: false,
    loading_msg_more: false,
    loading_no_history: true,
    first_hight: true,
    maxid: 0,
    minid: 999999999,
    timestr_last: 0,
    create: function () {
        this.loadmsg(true);
        var e = this;
        setInterval(function () {
            e.loadmsg(false)
        }, 8e3);
        return this
    },
    loadmsg: function (e) {
        if (this.loading_msg) {
            return
        }
        this.loading_msg = true;
        var t = this;
        $.ajax({
            url: go_Getmsg, data: {maxid: t.maxid, minid: t.minid}, type: "post", success: function (s) {
                if (s == 302) {
                    location.reload();
                    return
                }
                if (s != null) {
                    // console.log(s);
                    if (s.maxid > t.maxid) t.maxid = s.maxid;
                    is_Opened = parseInt(s.isOpened);
                    isback = parseInt(s.isback);
                    // $.tip(is_Opened)
                    $(s.del).each(function (e, t) {
                        MsgLoader.deleteMsgbox(t)
                    });
                    if (s.msg != null && s.msg.length > 0) {
                        var i = $(".msg_list_ctx").outerHeight() - $(window).height() - $("body").scrollTop();
                        t.appendData(s.msg, false);
                        if (e || i < 300) {
                            $("body").scrollTop($("#wall_window").height())
                        }
                        t.loading_no_history = false
                    }
                }
            }, dataType: "json", complete: function () {
                if (t.first_hight) {
                    setTimeout(function () {
                        $("body").scrollTop("10000")
                    }, 500)
                }
                t.first_hight = false;
                t.loading_msg = false
            }
        })
    },
    loadmore: function () {
        if (this.loading_msg_more) {
            return
        }
        if (this.loading_no_history) {
            return
        }
        this.loading_msg_more = true;
        var e = this;
        $.ajax({
            url: load_history_msg_url, data: {minid: e.minid}, type: "post", success: function (t) {
                if (t == 302) {
                    location.reload();
                    return
                }
                if (t != null && t.msg != null && t.msg.length > 0) {
                    e.loading_msg_more = false;
                    e.appendData(t.msg, true)
                } else {
                    $(".top_loadmore").slideUp(500, function () {
                        $(this).remove()
                    })
                }
            }, dataType: "json"
        })
    },
    deleteMsgbox: function (e) {
        if ($("#msg_box_" + e) != null) {
            $("#msg_box_" + e + "").prev(".timestr").remove();
            $("#msg_box_" + e + "").remove()
        }
    },
    deleteData: function (e) {
        if (e.del) {
            $(e.del).each(function (e, t) {
                MsgLoader.deleteMsgbox(t)
            })
        }
    },
    appendData: function (e, t) {
        var s = this;
        $(e).each(function (e, s) {
            if (s.id < MsgLoader.minid) MsgLoader.minid = s.id;
            var i = "";
            if (!t && s.createtime > MsgLoader.timestr_last + 15 * 60 || t) {
                if (!t) MsgLoader.timestr_last = s.createtime;
                var n = new Date;
                n.setTime(s.createtime * 1e3);
                i += '<div class="timestr" val="' + s.createtime + '">' + n.format("MM-dd hh:mm") + "</div>"
            }
            i += '<div class="msg_box" id="msg_box_' + s.id + '" mId="' + s.id + '">';
            i += '<img class="avatar" src="' + s.avatar + '" msgid="' + s.id + '" />';
            i += '<div style="overflow: auto">';
            i += '<div class="nickname_line"><span class="say_point"></span><div class="nickname">';
            i += '<span class="name_sapn">' + s.nickname + "</span>";
            if (s.wordimg && s.type == "0"&&s.from_user!=s.uid) {
                i += '  <span class="weitabp" data-id="' + s.id + '" data-sid="' + s.from_user + '">为Ta霸屏</span>'
            }
            if (s.wordimg && s.type === "1"&&s.from_user!=s.uid) {
                i += '  <span class="weitabp" data-id="' + s.id + '" data-sid="' + s.from_user + '">为Ta霸屏</span>'
            }
            if (isadmin==1) {
                i += '  <span class="iconfont icon-icon del_btn" msgid="' + s.id + '"></span>'
            }
            i += "</div></div>";
            if (s.type == "3") {
                i += '<div class="redpack_content openredpack" data-id="' + s.gift_id + '">';
                i += "<p>" + s.word + "</p>";
                i += '<p style="margin-top: 0.5rem;font-size:1.1rem;">点击领取</p>';
                i += "</div>"
            } else {
                i += '<div class="content">';
                var a = s.wordimg !== null && s.wordimg !== "";
                if (a) {
                    if ($.isArray(s.wordimg)) {
                        if (s.wordimg.length === 1) {
                            i += '<div class="img_box">'
                        } else {
                            i += '<div class="img_box_m">'
                        }
                        if (s.type === "1" && (typeof s.extend_params === "object" && s.extend_params) && s.extend_params.ext1 && s.extend_params.ext1.video) {
                            i += '<img src="' + s.wordimg + '" _src="' + s.wordimg + '" class="msg_ctx_image" data-url="' + s.extend_params.ext1.video + '" />'
                        } else if (s.type === "1" && (typeof s.extend_params === "object" && s.extend_params) && s.extend_params.sec_info) {
                            i += "<p>" + s.nickname + '为<span class="bp_title_high">' + s.extend_params.sec_info.nickname + "</span>豪气霸屏</p>";
                            $(s.wordimg).each(function () {
                                i += '<img src="' + this + '" _src="' + this + '" class="msg_ctx_image"/>'
                            })
                        } else {
                            $(s.image).each(function () {
                                i += '<img src="' + this + '" _src="' + this + '" class="msg_ctx_image"/>'
                            })
                        }
                        i += "</div>"
                    } else {
                        if(s.type === "4"){
                            i += '<div class="img_box"><video src="' +s.wordimg + '" _src="' +s.wordimg + '" class="msg_ctx_image" data-url="' + s.wordimg + '"/></div>'

                        }else{
                            i += '<div class="img_box"><img src="' +s.wordimg + '" _src="' +s.wordimg + '" class="msg_ctx_image"/></div>'
                        }
                    }
                }
                if (s.type !== "7" && s.type !== "vt" && s.word) {
                    i += "<p>" + s.word + "</p>"
                }
                if (s.type == "ap" && s.word == "") {
                    i += "<p>...</p>"
                }
                i += "</div>"
            }
            var o = $(i);
            if (s.type !== "0") {
                var c = "";
                if (a) {
                    c = " has_image"
                }
                if (s.type === "1"||s.type === "4"||s.type === "5") {
                    if (s.type==5 && s.for_nickname) {
                        o.find(".content").addClass("item_bp").prepend("<div class='bp_header'>为" + s.for_nickname + "霸屏" + s.bptime + "秒</div>")
                    } else {
                        o.find(".content").addClass("item_bp").prepend("<div class='bp_header'>豪气霸屏：" + s.bptime + "秒</div>")
                    }
                } else if (s.type === "2") {
                    o.find(".content").addClass("item_ds").prepend("<div class='ds_header'>重金打赏：<span class='el_title_high'>" + s.says + "</span></div>")
                } else if (s.type === "6") {
                    o.find(".content").prepend("<p>向<span class='el_title_high'>" + s.for_nickname + "</span>真情告白</p>");
                    o.find(".content").addClass("item_el").prepend("<div class='el_header'>表白：" + s.extend_params.bb_name + "</div>")
                } else if (s.type === "7") {
                    o.find(".content").prepend("<p>赠送<span class='el_title_high'>" + s.says + "</span>" + s.word + " 给<span class='el_title_high'>" + s.for_nickname + "</span></p>");
                    o.find(".content").addClass("item_sl").prepend("<div class='sl_header'>送礼：" + s.word + "</div>")
                } else if (s.type === "vt") {
                    o.find(".content").prepend("<p>赠送<span class='el_title_high'>" + s.extend_params.ext1.number + "</span>" + s.extend_params.ext1.unit + s.extend_params.ext1.gift_name + "给<span class='el_title_high'>" + s.extend_params.sec_info.nickname + "</span></p>");
                    o.find(".content").addClass("item_vt").prepend("<div class='sl_header'>送礼：" + s.content + "</div>")
                } else if (s.type === "ap") {
                    o.find(".content").addClass("item_bp").prepend("<div class='bp_header'>机霸：" + s.play_time + "秒</div>")
                }
            } else if (a) {
                o.find(".content").addClass("has_img")
            }
            if (t) {
                $(".msg_list_ctx").prepend(o)
            } else {
                $(".msg_list_ctx").append(o)
            }
            MsgList[s.id] = s
        })
    }
};
var MsgList = [];
function scroll_ctx() {
    setTimeout(function () {
        var e = $(".msg_list_ctx").outerHeight();
        $("body").animate({scrollTop: e}, 600)
    }, 500)
}
Date.prototype.format = function (e) {
    var t = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S+": this.getMilliseconds()
    };
    if (/(y+)/i.test(e)) {
        e = e.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length))
    }
    for (var s in t) {
        if (new RegExp("(" + s + ")").test(e)) {
            e = e.replace(RegExp.$1, RegExp.$1.length == 1 ? t[s] : ("00" + t[s]).substr(("" + t[s]).length))
        }
    }
    return e
};