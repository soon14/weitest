function scroll_ctx(i) {
    setTimeout(function () {
        var t = i.find(".msg_list_ctx").outerHeight();
        $("body").animate({scrollTop: t}, 600)
    }, 500)
}

//敏感词
var keyWord = {
    systemWord:keyword,

    check:function(val){
        if($.trim(val).length==0)
            return true;
        if(this.systemWord==null||this.systemWord=='')
            return true;
        for(var x in this.systemWord){
            var arr = this.systemWord[x].split(' ');
            var newArr = [];
            for(var y=0;y<arr.length;y++){
                var e = $.trim(arr[y]);
                if(e.length>0)
                    newArr.push(e);
            }
            //console.log(newArr);
            var bool = false;
            for(var i=0;i<newArr.length;i++){
                var e = $.trim(newArr[i]);

                if(val.indexOf(e)==-1){
                    bool = true;
                }

            }
            if(!bool){
                //ajax_word(x);
                return false;
            }

        }
        return true;
    },
    list:bp_listword,
    replace:function(val){

        if(this.list==null||this.list=='')
            return val;

        for(var x in this.list){
            var arrs = this.list[x].split(' ');
            var newArr = [];
            for(var yy=0;yy<arrs.length;yy++){
                var e = $.trim(arrs[yy]);
                if(e.length>0)
                    newArr.push(e);
            }
            for(var i=0;i<newArr.length;i++){
                var e = $.trim(newArr[i]);

                //console.log(e);
                if(val.indexOf(e)!=-1){
                    var len = e.length;
                    var res = '';
                    for(var i=0;i<len;i++)
                        res += '*';
                    var reg = new RegExp(e,"g");
                    val = val.replace(reg,res);
                }

            }

        }
        return val;
    }
}
//
//删除消息
var ajax_del = function(tid,isporn,fn1,fn2){
    $.post(go_deletemsg,{msgid:tid,isporn:isporn},function(result){
        console.log(result);
        if(result.isResultTrue){
            fn1();
        }else{
            fn2(result.resultMsg);
        }
    },'json');
}
//
//拉黑
var ajax_black = function(userId,index,fn1,fn2){
    //增加index 1:3天 2:永久
    $.post(go_pullblack,{userid:userId,type:index},function(result){
        //console.log(result);
        if(result.isResultTrue){
            fn1();
        }else{
            fn2(result.resultMsg);
        }
    },'json');
}


function toBlack(e,from_user){
    var able = true;
    WM.Phone.get({
        type:'confirm',
        title:'拉黑',
        btnText:['取消','永久拉黑'],
        innerHTML:'确定将此用户拉入黑名单？',
        click:function(b,btn,btnIndex){
            if(!b)
                return this.close();
            if(!able)
                return;
            var parent = e.parentNode;
            //var userId = $(this).val();
            var userId = $(parent).find('.aBlack').data('id');
            var t = this;

            WM.Phone.setButton(btn,false);
            able = false;
            ajax_black(userId,btnIndex,function(){
                t.close();
                $.tip("拉黑成功~");
            },function(errorMsg){
                able = true;
                WM.Phone.setButton(t.getButton()[1],true);
                showInfo(errorMsg||'操作失败',false);
            });
        }
    })
}

function del(e,id){
    WM.Phone.get({
        type:'confirm',
        title:'删除',
        innerHTML:'确定删除此上墙内容？',
        click:function(b){
            if(!b)
                return this.close();
            //var parent = e.parentNode;
            //var tid = e.data('id');
            var tid = id;
            var t = this;
            //console.log(e);
            //console.log(tid);
            //
            //return;
            WM.Phone.setButton(this.getButton()[1],false);
            ajax_del(tid,false,function(){
               // $(parent).remove();
                t.close();
                window.location.reload();
            },function(errorMsg){
                WM.Phone.setButton(t.getButton()[1],true);
                showInfo(errorMsg||'删除失败',false);
            });
        }
    });
}

function bpForOther(i) {

    if (0 == is_opened)
    {
        $.tip("大屏幕尚未开启~");
        return;
    }

    if (1 == isback)
    {
        $.tip("您已经被禁言,不能未他人霸屏了");
        return;
    }
    var t = $(i).attr("img"); e = $(i).attr("n");
    var nickname = "为"+e+"霸屏";
    $(".mzh_modal_alert_title #title").html(nickname)
    $(".bp_panel").show();
    $(".bp_tc_item").click(function () {
        $(".bp_tc_item").removeClass("active"), $(this).addClass("active")
    });
    var a = $(".bp_img_field");

    $(".bp_img_field img").attr("src",t);
        $("input[name=imgSrc]").val(t);
        $("input[name=type]").val("5");
        $("input[name=nickname]").val(e);

    //return;
    //    $.confirm("霸屏", n, function () {
    //    var i = $.trim(n.find("textarea").val()), a = t;
    //    return "" == i && "" == a ? void $.tip("请填写霸屏内容或图片") : ("" != e && n.find("input[name=nickname]").val(e), n.find("input[name=bp_index]").val(parseInt(n.find(".active").attr("val"))), void n.find("form").submit())
    //}, function () {
    //}, "开始霸屏")
}
function dsToSomeone(i) {
    wall.ds_data.guest_id = i, console.info("xxxxx" + i), $(".wall_menu_ds").trigger("click")
}
function BpAgain(i) {
    $.post(reBp_url, {id: i}, function (i) {
        $.tip(i.description)
    }, "json")
}
function fillHistoryData(i) {
    var t = $(".msg_box").eq(0).attr("mId");

    if (i.data && 0 != i.data.length) {

        for (var e = i.data, n = i.uid, a = i.isMaster, s = e.length, d = "", l = 0; l < s; l++){

        d += '<div class="timestr" val="' + e[l].createtime + '">' + i.time + "</div>";
        d += '<div class="msg_box ' + (e[l].from_user == n ? "mine" : "") + '" id="msg_box_' + e[l].id + '" mId="' + e[l].id + '">';
        d += '<div class="avatar" ' + (e[l].avatar ? 'style="background-image: url(' + e[l].avatar + '?x-oss-process=style/avatar)"' : "") + ' avatar="' + e[l].avatar + '" nickname="' + e[l].nickname + '" uid="' + e[l].from_user + '"></div>';
        d += '<div style="overflow: auto">';
        d += '<div class="nickname_line">';
        //

        if (e[l].from_user == n) {
            d += '<div class="nickname">';
        } else {
            d += '<div class="nickname">' + e[l].nickname;
        }
        if (e[l].wordimg && e[l].from_user != n) {
            d += '<span class="bp-font-color"  onclick="bpForOther(this)" img="' + e[l].wordimg + '" n="' + e[l].nickname + '"> 为Ta霸屏</span>';
        }
        //else {
        //    d += '<span class="bp-font-color" onclick="bpForOther(this)" img="' + e[l].wordimg + '" n="">我要霸屏</span>';
        //}
        //if (1 == a||e[l].from_user == n) {
        //    d += '<a href="javascript:void(0)" class="admin_del_msg" val="' + e[l].id + '">删除</a>';
        //}
        d += '</div>';
        d += '</div>';

        ////

        if (e[l].is_bp == 1 && e[l].gift == 0) {

            d += '<div class="content" style="background-image: url(../addons/haoman_dpm/imgs/ds_msg_bg.png)">';
            d += '<span class="say_point"></span>';
            if(e[l].type == 5){
                d += '<span style="color:#FFDD1B;font-weight: 900">为"'+e[l].for_nickname+'"重金霸屏' + e[l].bptime + '秒：</span>';
            }else{
                d += '<span style="color:#FFDD1B;font-weight: 900">重金霸屏' + e[l].bptime + '秒：</span>';
            }

            d += '<span class="bp-font-color2">' + e[l].word + '</span>';
            if (e[l].wordimg) {
                if(e[l].type==4){
                    d += '<video src="'+ e[l].wordimg + '" data-url="'+ e[l].wordimg +'" class="msg_ctx_image" wmode="transparent" style=" width: 100%;display: inline-block;" autoplay></video>';

                }else {
                    d += '<img src="' + e[l].wordimg + '" _src="' + e[l].wordimg + '" class="msg_ctx_image"/>';

                }
            }
            d += '<img style="float: right;width: 100%" src="../addons/haoman_dpm/imgs/bp_footer.png">';
        } else if (e[l].type == 2 && e[l].is_bp == 1) {

            d += '<div class="content" style="background-image: url(../addons/haoman_dpm/imgs/ds_msg_bg.png)">';
            d += '<span class="say_point"></span>';
            d += '<span style="color:#FFDD1B;font-weight: 900;">重金打赏：</span>';
            d += '<span class="bp-font-color2">' + e[l].word + '</span>';
            d += '<br />';
            d += '<span class="bp-font-color2">' + e[l].says + '</span>';
            if (e[l].wordimg) {
                d += '<img src="' + e[l].wordimg + '" _src="' + e[l].wordimg + '" class="msg_ctx_image"/>';
            }
            d += '<img style="float: right;width: 100%" src="../addons/haoman_dpm/imgs/ds_footer.png">';
            d += '</div>';

        }else if (e[l].type == 3&&e[l].gift_id!=0) {
                d += '<div class="hb_box" rpid="' + e[l].gift_id + '">';
                d += '<div class="hb_box_ctx">' + e[l].word + '</div>';
                d += '</div>';
            }
        else if(e[l].is_bp == 0) {

            d += '<div class="content">';
            d += '<span class="say_point"></span>' + e[l].word;
            if (e[l].wordimg) {
                d += '<img src="' + e[l].wordimg + '" _src="' + e[l].wordimg + '" class="msg_ctx_image"/>';
            }

        }

            d += '</div>';
        //if(e[l].from_user==n){
        //    d +='<a href="javascript:void(0)" class="admin_del_msg" val="' + e[l].id + '">删除</a>';
        //}else{
        //    d +='<span class="del_msg_ck iconfont icon-checkbox" val="' + e[l].id + '"></span>';
        //}
        //            $aa .='<span class="aDel" onclick="onWall.del(this)">删除</span>';
        //            $aa .='<span class="aBlack" onclick="onWall.toBlack(this)">拉黑</span>';
        //
        d += '</div>';

            if (1 ==a||e[l].from_user==n) {
                //或才是，与是错的
                d +='<div class="admin_del_msgs">';
                if(e[l].from_user==n){
                    d +='<span class="aDel" onclick="del(this,'+e[l].id+')" data-id="'+e[l].id+'">删除</span>';
                }else{
                    if(1 ==a){
                        d +='<span class="aDel" onclick="del(this,'+e[l].id+')" data-id="'+e[l].id+'">删除</span>';

                        d +='<span class="aBlack" onclick="toBlack(this)" data-id="'+e[l].from_user+'">拉黑</span>';
                    }

                }


                d +='</div>';
            }

        d += '</div>';

    }

        $.tip("数据加载完成");
        $("#msg_box_" + t).prev(".timestr").before(d);
    } else{
        $.tip("没有更多历史消息了！")
      }

}

function order() {
    location.href = Charts
}
$.fn.wall = function () {

    function nn(dt){

            if (dt != null && dt.length > 0) {
                for (var x = 0; x < dt.length; x++) {
                    rich.add(dt[x]);
                }
            }

            rich.init();

    }

    function bp(resultMsg,num){
        var obj = resultMsg;
        var dt = [];

        for (var ii = 0; ii < num; ii++) {
            var ob = {
                type: obj[ii].type, //0普通，1霸屏，2打赏，3红包，4视频，5为人霸屏，6表白,7礼物
                tid: obj[ii].id,
                img: obj[ii].wordimg,
                txt: obj[ii].word,
                src: obj[ii].avatar,
                userName: obj[ii].nickname,
                sit: '',
                sex: '',
                time: obj[ii].bptime,
                bpForTa: obj[ii].for_nickname,
                gift: obj[ii].gift,
                giftId: obj[ii].gift_id,
                say: obj[ii].says

            };
            dt.push(ob);
        }

        nn(dt)

    }

    function i() {
        $("#ds-step-1").show(), $("#ds-step-opera-1").show(), $("#ds-step-2").hide(), $("#ds-step-opera-2").hide()
    }

    function t() {
        $.post(go_play_reward_url, null, function (i) {
            if (0 == i.error) {
                s.guest_list = i.guest_list, s.item_list = i.item_list;

                var t = $(".fl-template>.fl-template-guest").html(), e = $("#ds-step-1").find(".fl-slide-content")[0];
                e = $(e), e.empty();
                // console.log(t)

                for (var n = "", a = 0; a < s.guest_list.length; a++) {
                    // console.log(s.guest_list[a].pic)
                    var d = s.guest_list[a];
                    var dpic = rootimg + d.pic;
                    // console.log(dpic);
                    var l = t.replace("##name##", d.name).replace("##id##", d.id).replace("http://", dpic).replace("##role##", d.type);
                    d.id == s.ds_data.guest_id && (l = l.replace('"fl-ds-guest"', '"fl-ds-guest selected"')), a % 6 == 0 && ("" != n && (n += "</div>"), n += '<div class="fl-slide-panel">'), n += l
                }
                n += "</div>", e.html(n), $.TouchSlide({
                    slideCell: "#ds-step-1",
                    titCell: ".fl-slide-pager ul",
                    mainCell: ".fl-slide-content",
                    autoPage: !0
                }), $(".fl-ds-guest").click(function () {
                    s.ds_data.guest_id = $(this).attr("data-id"), $(".fl-ds-guest.selected").removeClass("selected"), $(this).addClass("selected"),$("input[name=guest_id]").val($(this).attr("data-id"))
                })
            }else{
                $.tip('为获取到打赏对象、打赏礼物')
            }
        }, "json")
    }

    function e(i) {
        for (var t = 0; t < s.guest_list.length; t++)if (s.guest_list[t].id == i)return s.guest_list[t];
        return null
    }

    function n(i) {
        for (var t = 0; t < s.item_list.length; t++)if (s.item_list[t].id == i)return s.item_list[t];
        return null
    }

    var a = $(this),
        s = {guest_list: [], item_list: [], ds_data: {guest_id: 0, item_id: 0}},
        d = {video_src: null};
    return $(this).find(".send_btn").click(function () {

        if (1 == isback)
        {
            $.tip("您已经被禁言");
            return;
        }


        var i = a.find(".msg_input_box").val();
        if(!keyWord.check(i)){
            a.find(".msg_input_box").val('')
            return $.tip('请勿发布广告等不适内容');
        }

        //敏感词
        i = keyWord.replace(i);
        return "" == $.trim(i) ? void $.tip("信息为空") : (a.find(".msg_input_box").val(""), void $.post(go_sendmsg, {content: i}, function (i) {
            console.log(i.code), 1 == i.code ? (a.find(".showing_face").removeClass("showing_face"), a.find(".showing_menu").removeClass("showing_menu"), a.find(".msg_list_ctx").css("padding-bottom", "4rem"),$(".right_index").css("bottom", "15%"), $.tip(i.data), a.loadmsg()) : $.tip("信息发送失败...")
        }, "JSON"))
    }),
     a.find(".msg_input_menu .photo_filess").upload_image(function (i) {

        $.getJSON(go_sendmsg, {image: i}, function (i) {
            $.loadingModal(!1), i.code == -2 && $.alert(i.data), a.loadmsg()
        })
    }),
        $(this).find(".msg_input_menu .menu_del").click(function () {
        return a.find(".msg_del_btn").is(":visible") ? (a.find(".del_msg_ck").hide(), void a.find(".msg_del_btn").hide()) : (a.find(".del_msg_ck").show(), a.find(".msg_del_btn").show().unbind("click").click(function () {
            var i = new Array;
            return $.each(a.find(".icon-gouxuan"), function (t, e) {
                i.push($(this).attr("val"))
            }), 0 == i.length ? (a.find(".del_msg_ck").hide(), void a.find(".msg_del_btn").hide()) : void $.getJSON("/app/index.php?i=" + uniacid + "&c=entry&m=0&do=delmsg", {tid: i}, function (i) {
                location.reload()
            })
        }), void a.find(".del_msg_ck").parent().unbind("click").click(function () {
            $(this).find(".del_msg_ck").toggleClass("icon-checkbox").toggleClass("icon-gouxuan")
        }))
    }), $(this).find(".msg_list").click(function () {
        $(".msg_input").hasClass("showing_menu") && $(".msg_input").removeClass("showing_menu")
    }), $(".wall_menu_ds").click(function () {
        if (0 == is_opened)
        {
            $.tip("大屏幕尚未开启~");
            return;
        }
        if (1 == isback)
        {
            $.tip("您已经被禁言,打赏他人了");
            return;
        }
        //if (0 == isOpened)return $.tip("大屏幕尚未开启~"), !1;
        var a = $(".ds_panel");
            $("body").append(a);

        $(".content video").hide();
            t();
            a.find("#ds-step-1").show();
            a.show();

            a.find(".close,#ds-cancel-btn").unbind("click").click(function () {
            i(), a.hide(),$(".content video").show()
        });
            a.find("#ds-back-btn").unbind("click").click(function () {
            $("#ds-step-1").show(), $("#ds-step-opera-1").show(), $("#ds-step-2").hide(), $("#ds-step-opera-2").hide()
        });
        a.find("#ds-next-btn").unbind("click").click(function () {
           var x= $("input[name=guest_id]").val();

            if(x<0||x==''){
                $(".fl-ds-guest.selected").removeClass("selected")
                $.tip("请选择打赏对象！");
                return;
            }
            if (s.ds_data.guest_id > 0) {
                var i = e(s.ds_data.guest_id);
                a.find(".ds-guest-name").text(i.name);
                var t = $(".fl-template>.fl-template-item").html();
                d = $("#ds-step-2").find(".fl-slide-content")[0];
                d = $(d);
                d.empty();
                html = "";
                for (var l = 0; l < s.item_list.length; l++) {

                    var o = s.item_list[l];
                    var opic = rootimg + o.pic;
                    c = t.replace("##name##", o.name).replace("##id##", o.id).replace("http://", opic).replace("##price##", "￥" + o.price).replace("##says##", o.says);

                    l % 6 == 0 && ("" != html && (html += "</div>"), html += '<div class="fl-slide-panel">'), html += c
                }
                html += "</div>";

                d.html(html);
                a.find("#ds-step-1").hide();
                a.find("#ds-step-2").show();
                $.TouchSlide({
                    slideCell: "#ds-step-2",
                    titCell: ".fl-slide-pager ul",
                    mainCell: ".fl-slide-content",
                    autoPage: !0
                }), $(".fl-ds-item").click(function () {
                    s.ds_data.item_id = $(this).attr("data-id");
                    $("input[name=item_id]").val(s.ds_data.item_id)
                    $(".fl-ds-item.selected").removeClass("selected");
                    $(this).addClass("selected");
                    var i = n(s.ds_data.item_id);
                    null != i && $(".ds-price").text(i.price), $("#ds-field-says").val($(this).attr("data-says"))
                }), $("#ds-step-1").hide(), $("#ds-step-opera-1").hide(), $("#ds-step-2").show(), $("#ds-step-opera-2").show()
            }
        })
    }),$(".wall_menu_gift").click(function () {
        window.location.href = go_gift, console.info("click")
    }),$(".wall_menu_mf").click(function () {
        window.location.href = go_makefriends;
    }),
    //    $(".wall_menu_bp,.wall_menu_video").click(function () {
    //    if (0 == isOpened)return void $.tip("大屏幕尚未开启~");
    //    var i = $(".temp_bp_panel").clone(), t = $(this).hasClass("wall_menu_bp");
    //    if (t) {
    //        var e = "霸屏";
    //        i.find("img").attr("src", "../addons/haoman_dpm/imgs/zp.png"), i.find("#upload").attr("accept", "image/*"), i.find("#bp_pic_effect").show(), i.find("textarea").val("")
    //    } else {
    //        var e = "小电影上墙";
    //        i.find("img").attr("src", "../addons/haoman_dpm/imgs/video.png"), i.find("#upload").attr("accept", "video/*"), i.find("input[name=type]").val("video"), i.find("textarea").val("请大家看小电影")
    //    }
    //    i.show().find(".bp_tc_item").click(function () {
    //        i.find(".bp_tc_item").removeClass("active"), $(this).addClass("active")
    //    });
    //    var n, a = i.find(".bp_img_field");
    //
    //    a.find(".photo_file").upload_image(function (t, e) {
    //        "video" == e ? a.find("img").attr("src", "../addons/haoman_dpm/imgs/video@checked.png") : a.find("img").attr("src", rootimg+t), i.find("input[name=imgSrc]").val(t), n = t, $.loadingModal(!1)
    //    }),
    //    $.confirm(e, i, function () {
    //        var e = $.trim(i.find("textarea").val()), a = i.find("input[name=imgSrc]").val();
    //        return t && "" == e && "" == a ? void $.tip("请填写霸屏内容或图片") : t || "" != a ? (i.find("input[name=bp_index]").val(parseInt(i.find(".active").attr("val"))), i.find("input[name=imgSrc]").val(n), bp()) : void $.tip("请填上传小电影")
    //    }, function () {
    //    }, "立即霸屏")
    //}),
        $(".wall_menu_bp,.wall_menu_video").click(function () {
            if (0 == is_opened)
            {
                $.tip("大屏幕尚未开启~");
                return;
            }
            if (1 == isback)
            {
                $.tip("您已经被禁言,不能霸屏了");
                return;
            }
        //if (0 == isOpened)return void $.tip("大屏幕尚未开启~");
        var t = $(this).hasClass("wall_menu_bp");
            $("input[name=imgSrc]").val('');
        if (t) {
            var e = "霸屏";
            $(".for_video").hide()
            $(".for_photo").show()
            $(".mzh_modal_alert_title #title").html(e)
           $(".bp_img_field img").attr("src", "../addons/haoman_dpm/imgs/zp.png"),$(".bp_img_field #upload2").attr("disabled", false),$(".bp_img_field #upload1").hide(),$(".bp_img_field #upload2").show(), $(".bp_ctx textarea").val("")
        } else {
            var e = "小电影上墙";
            $(".mzh_modal_alert_title #title").html(e);
            $(".for_video").show()
            $(".for_photo").hide()
            $(".bp_img_field video").hide()
            // $(".bp_img_field img").show()

            $(".bp_img_field img").attr("src", "../addons/haoman_dpm/imgs/video.png"), $(".bp_img_field #upload2").attr("disabled", true), $(".bp_img_field #upload1").show(),$(".bp_img_field #upload2").hide(), $("input[name=type]").val("4"), $(".bp_ctx textarea").val("请大家看小电影")
        }
            $(".content video").hide();
            $(".bp_panel").show();
            $(".bp_tc_item").click(function () {
            $(".bp_tc_item").removeClass("active"), $(this).addClass("active")
            $("input[name=bp_index]").val(parseInt($(this).attr("val")));
        });
        var n, a = $(".bp_img_field");

        a.find(".photo_file2").upload_image(function (t, e) {
          if("video" == e){
              a.find("img").hide();
              a.find("video").attr("src", rootimg+t)
              a.find("video").show();
          }else{
              a.find("img").attr("src", rootimg+t)
          }
           $("input[name=imgSrc]").val(t), n = t, $.loadingModal(!1)
        })

    }), $(".wall_menu_hb").click(function () {
        if (0 == is_opened)
        {
            $.tip("大屏幕尚未开启~");
            return;
        }
        $(".content video").hide();
            $(".hb_panels").show();

    }), $(this).on("click", ".hb_box", function () {
        var i = $(this).attr("rpid");
        $(".content video").hide();
        if(clicks){
            return $.tip("请不要频繁点击");
        }
        clicks=true;
        $.post(go_RedPackStatus, {id: i}, function (t) {
            if(t==404){
                $.tip("参数错误！");
                clicks=false;
                return
            }
            clicks=false;
            var e = $(t).appendTo($("body"));
            e.find(".close").click(function () {
                e.remove();
                $(".content video").show();
            });
            e.on("click", ".show_log", function () {
                $(".content video").hide();
                $.loadingModal(!0, "加载中"), $.post(go_RedPackLuck, {id: i}, function (i) {
                    $.loadingModal(!1, "加载中"), e.remove();
                    var t = $(i).appendTo($("body"));
                    t.find(".close").click(function () {
                        t.remove();
                        $(".content video").show();
                    })
                }, "json")
            })
        }, "json")
    }), $(this).find(".msg_input_box").focus(function () {
        setTimeout(function () {
            $(window).scrollTop(9e3)
        }, 300)
    }), $(this).find(".menu_btn").click(function () {
        a.find(".msg_input").removeClass("showing_face").toggleClass("showing_menu").hasClass("showing_menu") ? a.find(".msg_list_ctx").css("padding-bottom", "12rem") : a.find(".msg_list_ctx").css("padding-bottom", "4rem")
    }), $(this).find(".smile_btn").click(function () {
        a.find(".msg_input").removeClass("showing_menu").toggleClass("showing_face").hasClass("showing_face") ? (a.find(".msg_list_ctx").css("padding-bottom", "16rem"),$(".right_index").css("bottom", "17rem")) : (a.find(".msg_list_ctx").css("padding-bottom", "4rem"),$(".right_index").css("bottom", "15%"))
    }), $(this).on("click", ".msg_box .avatar", function () {
        var i = $(this);
        if (!$(this).parent().hasClass("mine")) {
            $(".userBox").fadeIn(), $(".userBox").find(".userBg").attr("src", $(this).attr("avatar")), $(".userBox").find(".send_msg").click(function () {
                //alert(go_talk+'&uid='+i.attr("uid"));
                location.href=go_talk+'&uid='+i.attr("uid");
                //location.href = "/app/index.php?i=" + uniacid + "&c=entry&m=0&do=talk&sid=" + i.attr("uid")
            });
            var t = !0;
            $(".userBox").find(".black_half_hour").click(function () {
                t && (t = !1, $.wall_talk_prevent(i.attr("uid"), 1800))
            }), $(".userBox").find(".black_one_day").click(function () {
                t && (t = !1, $.wall_talk_prevent(i.attr("uid"), 86400))
            }), $(".userBox").find(".black_forever").click(function () {
                t && (t = !1, $.wall_talk_prevent(i.attr("uid"), 359964e4))
            }), $(".userBox").find(".clear_black").click(function () {
                t && (t = !1, $.wall_talk_prevent(i.attr("uid"), 0))
            }), $(".userBox").find(".clear_msg").click(function () {
                t && (t = !1, $.wall_talk_prevent(i.attr("uid"), -1))
            }), $(".userBox").find(".express_love").click(function () {
                t && (t = !1, 0 == is_opened ? $.tip("大屏幕尚未开启~") : window.location.href = go_express_love +'&uid='+ i.attr("uid"))
            }), $(".userBox").find(".send_gift").click(function () {
                n && (t = !1, 0 == is_opened ? $.tip("大屏幕尚未开启~") :  window.location.href = go_gift+'&uid=' + i.attr("uid"))
            })
        }
    }), $(".wall_menu_box").click(function () {
        //location.href = box_url
    }), $(".wall_menu_sync_info").click(function () {
        //$.post(sync_info_url, null, function (i) {
        //    $.alert("", i.message)
        //}, "json")
    }), $(this).on("click", ".msg_box .admin_del_msg", function () {
        $.getJSON("/app/index.php?i=&c=entry&m=0&do=delmsg", {tid: [$(this).attr("val")]}, function (i) {
            location.reload()
        })
    }), $(this).on("click", ".msg_box .msg_ctx_image", function () {
        if ($(this).attr("data-url")) {
            var i = document.getElementById("perform_video");
            i.src = $(this).attr("data-url"), i.type = $(this).attr("data-type"), i.poster = $(this).attr("_src"), $(".show_video_msg_box").fadeIn()
        } else $(".show_img_msg_box").fadeIn().find("img").attr("src", $(this).attr("_src"))
    }), $(this).on("click", ".msg_box .msg_ctx_video_thum", function () {
        $(this).next().click()
    }), this.code_302 = 0, a.loading_msg = !1, a.loadmsg = function (i) {
        if (!a.loading_msg) {
            a.loading_msg = !0;
            var t = 0;
            a.find(".timestr").size() > 0 && (t = a.find(".timestr").last().attr("val")),
                $.ajax({
                url: go_Getmsg,
                data: {maxid: maxid, lt: t},
                type: "post",
                success: function (i) {
                   if(302 == i){
                       location.reload()
                   }else {
                       maxid = i.maxid;
                       is_opened = parseInt(i.isOpened);
                       isback= i.isback;
                       ismbp= i.ismbp;
                       resultMsg = i.list;
                       if(i.data&&i.data!=''){
                           a.find(".msg_list_ctx").append(i.data), a.smile(), scroll_ctx(a);
                       }

                       if(i.count>0&&ismbp==1){
                           num =i.count;
                           bp(resultMsg,num);
                       }

                   }
                    //return 302 == i ? void location.reload() : void(null != i && (maxid = i.maxid, is_opened = parseInt(i.isOpened),isback= i.isback, $(i.del).each(function (i, t) {
                    //    $("#msg_box_" + t).prev(".timestr").remove(), $("#msg_box_" + t).remove()
                    //}),null != i.data && "" != i.data && (a.find(".msg_list_ctx").append(i.data), a.smile(), scroll_ctx(a))))
                },
                dataType: "json",
                complete: function () {
                    a.loading_msg = !1
                }
            })
        }
    }, a.loadmsg(), a.smile("init"), setInterval(function () {
        a.loadmsg(!0)
    }, 1000), a.loading_notification = !1, a.load_notification = function () {
        return !a.loading_notification && (a.loading_notification = !0, void $.ajax({
                url: "/app/index.php?i=&c=entry&m=funlink_send_gift&do=Notify",
                data: {maxid: maxid},
                type: "post",
                success: function (i) {
                    return 302 == i ? void location.reload() : void(null != i && 0 == i.error && (console.info(i.notification), a.notify(i.notification)))
                },
                dataType: "json",
                complete: function () {
                    a.loading_notification = !1
                }
            }))
    }, $(".wall_menu_gift").length && setInterval(function () {
        //a.load_notification()//暂时注释了
    }, 5e3), a.notify_stack = [], a.notify = function (i) {
        if (a.notify_stack.indexOf(i.id) != -1)return !1;
        a.notify_stack.push(i.id);
        var n = document.createElement("div"), e = document.createElement("span");
        e.innerHTML = i.from_nickname, e.className = "fl-notify-nickname", n.appendChild(e);
        var t = document.createElement("span");
        t.innerHTML = "送给您" + i.number + i.unit + i.gift_name, n.appendChild(t);
        var s = document.createElement("span");
        s.innerHTML = "x", s.className = "fl-notify-close", n.appendChild(s);
        var l = document.createElement("a");
        l.innerHTML = "查看", l.className = "fl-notify-checkup", l.href = "/app/index.php?i=&c=entry&m=funlink_send_gift&do=pocket", n.appendChild(l), n.className = "fl-notify", $("body").append(n), s.onclick = function () {
            $(n).remove()
        }, $.post("/app/index.php?i=&c=entry&m=funlink_send_gift&do=response", {id: i.id}, null, "json")
    }, a = $.extend(a, d)

};


//2017-03-09新增
//霸屏
var rich = {
    noImgSrc:'../addons/haoman_dpm/bapinimg/tpsc.png',//删除图片替代路径
    noImg:function(e){
        $(e).attr({src:rich.noImgSrc});
    },
    list:[],
    setImage:function(e){
        var dir = $(e.parentNode).width()/$(e.parentNode).height();
        if($(e).width()/$(e).height()<=dir){
            $(e).css({width:'100%',left:0});
            var mt = ($(e).height()-$(e.parentNode).height())/-2;
            $(e).css({marginTop:mt,'visibility':'visible'});
        }else{
            $(e).css({height:'100%'});
            var ml = ($(e).width()-$(e.parentNode).width())/-2;
            $(e).css({marginLeft:ml,'visibility':'visible'});
        }
    },
    add:function(dt){
        if (dt.type == 7)
            dt.img = rich.noCakeSrc;
        this.list.push({
            type:dt.type,
            toName:dt.toName||'',//送给谁蛋糕
            giftId:dt.giftId==null?'':dt.giftId,
            tid:dt.tid,
            richImage:dt.img,
            richText:dt.txt,
            richHead:dt.src,
            richName:dt.userName,
            richSit:dt.sit,
            richSex:dt.Sex,
            richTime:dt.time,
            url:dt.url,
            say: dt.say,

            //为TA霸屏
            forTaBp:dt.bpForTa
            //搭讪参数
            //dsGift:dt.dsGift,
            //dsShowName:dt.dsShowName,
            //dsShowImage:dt.dsShowImage

        });
    },
    init:function(){


            if(rich.list.length>0){
                var dt = rich.list[0];
                //console.log(dt);
                rich.list.shift();
                rich.show(dt);
            }


    },
    show:function(dt){
        if(dt.type==2)
        {

            dt.giftTime = showTime = dsData[dt.giftId].time;
            this.dsShow(dt);
            return;
        }
        if(dt.type==7){
            cakeAnimate.show();
            return this.dsShow(dt,true);
        }
        //if(dt.num>1&&dt.type!='ds'&&dt.type!='cake'){
        //    rich.loop(dt);
        //}
        if($('#rich').length>0)
            return;
        //$('.onWall_newIcon2').addClass('disabled');
        //$($('.newActive')[0].parentNode.parentNode).addClass('disabled');
        var hasImage = dt.richImage!=null&&$.trim(dt.richImage).length>0&&dt.type!=4;
        var html = '<div id="rich">';
        if(hasImage){
            html += '<div class="richImage">';
            html += '<img onload="rich.setImage(this)" onerror="rich.noImg(this)"  src="'+dt.richImage+'" /></div>';
            html += '<div class="richInfo">';
        }else
            html += '<div class="richInfo noImage">';
        if(dt.type==4){
            html += '<p class="littleImageBox" style="width: 100%;height: 100%"><video class="littleImage" src="' + dt.richImage + '" loop="loop" autoplay style="height: 90%;"></video></p>';
        }
        if(dt.richText!=null&&dt.richText.length>0)
            html += '<div class="richTxt">'+dt.richText+'</div>';
        if(hasImage){
            var str = (dt.forTaBp!=null&&dt.forTaBp!=''&&dt.type==5)?'为 '+dt.forTaBp+' ':'';
            if(dt.richText!=null&&dt.richText.length>0){
                html += '<div class="richTime">'+str+'重金霸屏 <b id="richTime">'+dt.richTime+'</b> 秒</div>';
            }
            else
                html += '<div class="richTime noText">'+str+'重金霸屏 <b id="richTime">'+dt.richTime+'</b> 秒</div>';
        }
        html += '<div class="richUser">';
        if(dt.url!=null&&dt.url.length>0)
            html += '<a href="'+dt.richHead+'"><img class="'+dt.richSex+'" src="'+dt.richHead+'" /></a>';
        else{
            //系统霸屏
            html += '<a><img class="'+dt.richSex+'" src="'+dt.richHead+'" /></a>';
        }

        html += '<div><span class="tableSpan"><tt class="richUserName">'+dt.richName+'</tt>';
        if(!hasImage){
            var str = (dt.forTaBp!=null&&dt.forTaBp!=''&&dt.type==5)?'为 '+dt.forTaBp+' ':'';
            html += '<tt class="richTime">'+str+'重金霸屏 <b id="richTime">'+dt.richTime+'</b> 秒</tt>';
        }
        if(dt.richSit!=null&&dt.richSit!='')
            html += '<tt class="richSit">座席：<i>'+dt.richSit+'</i></tt>';
        html += '</span></div></div>';

        html += '</div></div>';

        $(html).appendTo($('body'));
        setTimeout(function(){
            Transition.go({
                obj:$('#rich')[0],
                style:{'-webkit-transform':'scale(1)','opacity':1}
            });
            rich.count(dt.richTime);
        },50);
    },
    count:function(time,type){
        time = parseInt(time);
        setTimeout(function(){
            if(time==-1)
                return rich.close(type);
            setTimeout(arguments.callee,1000);
            $('#richTime').html(time);
            time--;
        },0);
    },
    close:function(type){
        if(type){
            return $('#ds').fadeOut(function(){
                $('#ds').remove();
                rich.init();
            });
        }
        //$('.onWall_newIcon2').removeClass('disabled');
        $('#rich').fadeOut(function(){
            $('#rich').remove();
            rich.init();
        });
    },
    dsShow:function(dt,bool){

        bool = bool==null?false:bool;
        if(bool)
            dt.giftId = 'cake';
        var className,src,giftName,countTime;
        if(dt.giftId!=null&&dt.giftId!=''){
            className = dsData[dt.giftId].iconName;
            giftName = dsData[dt.giftId].name;
            countTime = dsData[dt.giftId].time;
        }

        //src = ds.imageUrl+className;
        //videoSrc =  dsData[dt.giftId].src;
        var html = '<div id="ds">';
        //html += '<img class="'+className+'" src="'+src+'.png" />';
        if(dt.dsShowImage!=null&&dt.dsShowImage.length>0)
            html += '<div class="richImage"><img onload="rich.setImage(this)" src="'+dt.dsShowImage+'"></div><div class="richInfo">';
        else
            html += '<div class="richInfo noImage">';
        if(bool)
            html += '<div class="dsTxt">为 <tt>'+dt.toName+'</tt> 霸屏：</div>';
        else
            html += '<div class="dsTxt">重金打赏：<tt>'+dt.richText+'</tt></div>';
        html += '<div class="dsObj">'+giftName+'</div>';

        if(dt.say!=null)
            html += '<div class="dsTxt" style="margin-top:14px; color:#fff; font-size:14px">'+dt.say+'</div>';
        if (dt.richImage != null && dt.richImage != ''){
            html += '<p class="littleImageBox"><img class="littleImage" src="' + dt.richImage + '" /></p>';
        }
        html += '<div class="richUser">';
        html += '<a href="'+dt.richHead+'"><img class="'+dt.richSex+'" src="'+dt.richHead+'"></a>';
        html += '<div><span class="tableSpan"><tt class="richUserName"><tt>'+dt.richName+'</tt>剩余 <b id="richTime" class="dsTime">'+countTime+'</b> 秒</tt></span></div>';
        html += '</div></div></div>';

        $(html).appendTo($('body'));

        setTimeout(function(){
            Transition.go({
                obj:$('#ds')[0],
                style:{'-webkit-transform':'scale(1)','opacity':1}
            });
            rich.count(countTime,true);
        },50)
    },
    loop:function(dt){
        setTimeout(function(){
            dt.num = parseInt(dt.num)-1;
            rich.add(dt);
        },(parseInt(dt.richTime)-5)*1000);
    }
}


var wall = null;

$(function () {
    wall = $("#wall_window").wall(),
        $(".userBox").click(function () {
           $(this).fadeOut()
        }),
        $(".show_img_msg_box, .show_video_msg_box").click(function () {
        var i = document.getElementById("perform_video");
        i.src = "",
        i.pause(),
        $(this).fadeOut()
    });
        $(window).scroll(function () {
        var i = $(window).scrollTop();
        if ($(".msg_box").eq(0) && 0 == i) {
            $.tip("加载中....");
            var t = $(".msg_box").eq(0).attr("mId");
            $.post(load_history_msg_url, {minid: t}, function (i) {
                fillHistoryData(i)
            }, "json")
        }
    })
});