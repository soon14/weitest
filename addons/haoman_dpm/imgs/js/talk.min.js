var talking = !1;
$.party_talk = function (n) {
    talking || (talking = !0, $.post("/app/index.php?i=" + uniacid + "&c=entry&m=0&do=talk", {sid: n}, function (i) {
        $(".talk_panel").not(".wall_chat").remove(), $("#main_body").addClass("showing_panel");
        var t = $(i);
        $("body").append(t), talking = !1, t.party_talk_panel(n)
    }, "html"))
}
$.fn.party_talk_panel = function (n) {
    var i = $(this);
    i.loadPrivMsg = function () {
        if (!i.loading_msg) {
            i.loading_msg = !0;
            var t = 0;
            i.find(".timestr").size() > 0 && (t = i.find(".timestr").last().attr("val")), $.post(get_Getmsg, {
                sid: n,
                maxid: maxid,
                lasttime: t
            }, function (n) {
                i.loading_msg = !1, null != n && "" != n && ( maxid = n.maxid,i.find(".msg_list_ctx").append(n.data), control.initFace(i.find(".msg_list")), i.scroll_ctx())
            }, "json")
        }
    };

    //i.is_online = function () {
    //    if (!i.loading_msg) {
    //        i.loading_msg = !0;
    //        var t = 0;
    //        i.find(".timestr").size() > 0 && (t = i.find(".timestr").last().attr("val")), $.post(get_Getmsg, {
    //        }, function (n) {
    //            console.log(n);
    //            i.loading_msg = !1, null != n && "" != n && ( maxid = n.maxid,i.find(".msg_list_ctx").append(n.data), control.initFace(i.find(".msg_list")), i.scroll_ctx())
    //        }, "json")
    //    }
    //};

    i.scroll_ctx = function () {
        //setTimeout(function () {
            var n = i.find(".msg_list_ctx").outerHeight();
            i.find(".msg_list").animate({scrollTop: n}, 600)
        //}, 1000)
    };
    i.slideDown(200, function () {
        i.scroll_ctx()
    }).find(".close").click(function () {
        i.slideUp(200, function () {
            i.remove(), $("#main_body").removeClass("showing_panel");
            //clearInterval(i.timerid)
        })
    }), i.find(".msg_input_box").focus(function () {
        setTimeout(function () {
            $(window).scrollTop(9e3)
        }, 300)
    }), i.find(".menu_btn").click(function () {
        i.find(".msg_input").removeClass("showing_face").toggleClass("showing_menu").hasClass("showing_menu") ? i.find(".msg_list_ctx").css("padding-bottom", "12rem") : i.find(".msg_list_ctx").css("padding-bottom", "4rem")
    }), i.find(".smile_btn").click(function () {
        i.find(".msg_input").removeClass("showing_menu").toggleClass("showing_face").hasClass("showing_face") ? i.find(".msg_list_ctx").css("padding-bottom", "16rem") : i.find(".msg_list_ctx").css("padding-bottom", "4rem")
    }), i.find(".msg_input_menu .photo_files").upload_image(function (t) {
        $.getJSON(get_Sendmsg, {
            acceptid: n,
            imgId: t
        }, function (n) {
            $.loadingModal(!1), n.code == -2 && $.alert(n.data), i.loadPrivMsg()
        })
    });
    i.find(".clean_msg").click(function () {
        $.loadingModal(!0, "信息清除中.."), $.getJSON(go_emptychat, {uid: n}, function (n) {
            $.loadingModal(!1), location.reload()
        })
    });
    i.find(".send_btn").click(function () {
        var t = i.find(".msg_input_box").val();

        return "" == $.trim(t) ? void $.tip("信息为空") : void $.post(get_Sendmsg,{acceptid: n,content: t}, function (x) {
            if(x.code==1){
                i.find(".msg_input_box").val("");
                i.find(".showing_face").removeClass("showing_face");
                i.find(".showing_menu").removeClass("showing_menu");
                i.find(".msg_list_ctx").css("padding-bottom", "4rem");
                i.loadPrivMsg();
                $.tip("信息发送成功")
            }else{
                $.tip("信息发送失败")
            }
        }, "JSON")
    });
    i.loading_msg = !1, i.timerid = setInterval(i.loadPrivMsg, 1000), i.smile("init");
}
$.wall_talk_prevent = function (n, i) {
    $.post("", {
        uid: n,
        time: i
    }, function (n) {
        $.tip(n.data)
    }, "json")
};