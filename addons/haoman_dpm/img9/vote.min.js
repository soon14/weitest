$(function(){
	var nowDate=0;
	var lastDate=0;
	var starttime  = 0;
	var endtime    = 0;
	var page=1;
	var loading = true;
	var openid  = $("#openid").val();
	var cid  = $("#cid").val();
	
	starttime  = $("#starttime").val();
	endtime    = $("#endtime").val();
	starttime = eval('new Date(' + starttime.replace(/\d+(?=-[^-]+$)/, function (a) { return parseInt(a, 10) - 1; }).match(/\d+/g) +')'); //转换为时间日期类型	
	starttime = starttime.getTime(); 
	endtime = eval('new Date(' + endtime.replace(/\d+(?=-[^-]+$)/, function (a) { return parseInt(a, 10) - 1; }).match(/\d+/g) +')'); //转换为时间日期类型	
	endtime = endtime.getTime(); 
	
	function show_list(page){
		var openid  = $("#openid").val();
		$.ajax({
			url : 'libs/vote_list.php',type : 'post',dataType : "json",async : false,
			data : {openid:openid,cid:cid,page:page},
			success : function(data) {
				if(data.s=='0'){
					$('#list').html(data.list);

					$("#list .p").lazyload();
					set_zoom();
				}
				if(data.s=='2'){location.reload();}
			},
			error : function(data, error) {
				show('系统忙，请稍后！');
			}
		});
	}
	
//	show_list(1);
	vote();

	$('#page span').click(function (){
		var page=$(this).html();
		show_list(page);
	});

	//查询
	$('#sb').unbind('click').bind('click',function(){
		var key=$("#st").val();
		var cid=$("#cid").val();
		if (key=='') {
			show('请输入关键词！');
			return;
		}
		$.ajax({
			url : vote_list,
			type : 'post',
			dataType : "json",
			async : false,
			data : {openid:openid,cid:cid,key:key},
			success : function(data) {
				if(data.s=='0'){
					$('#list').html(data.list);
					vote();
					// $("#list .p").lazyload();
					set_zoom();
					loading = false;
				}
				if(data.s=='1'){
					$('#list').html(data.list);
					show('查询不到，感谢支持！');
					loading = false;
				}
				if(data.s=='2'){location.reload();}
			},
			error : function(data, error) {
				show('系统忙，请稍后！');
			}
		});
	});
			
	//投票启动
	function vote(){
	  $('.a').unbind('click').bind('click',function(){
	     var oid=$(this).attr("id");

		// //关注
		//  var subscribe=$('#subscribe').val();
		//  if(subscribe=='0' || subscribe==''){
		// 	 $('#float_bg').show();
		// 	 $('#float_add').show().animate({bottom:'30%',opacity:'1'});
		// 	 return;
		//  }
		//开始时间
		//nowDate = new Date().getTime()/1000;

		  var timestamp = Date.parse(new Date());
		    nowDate = timestamp / 1000;
		if (nowDate - starttime < 0) {
			show('投票活动还没开始！');
			return;
		}
		//结束时间
		if (endtime - nowDate < 0) {
			show('投票活动已经结束！');
			return;
		}
		//获取地理位置
	//	if (latitude=='' || longitude=='') {
	//		show('正在获取您的位置，请稍候...<br>如无法获取不能参与活动！');
	//		return;
	//	}
	    //注册
        // var name=$("#name").val();
        // var mobile=$("#mobile").val();
        // if(name=='' || mobile==''){
			// $('#float_bg').show();
			// $('#float_reg').show();
			// return;
        // }
		//动作间隔时间
		if (nowDate - lastDate > 2) {
			lastDate = nowDate;
			set_vote(oid);
		}else{
			show('您的动作太快了！');
			return;
		}
	  });
	}
	
	// $("#b4").click(function(){
	// 	set_reg();}
	// );
	
	//投票
	function set_vote(oid){
		var openid  = $("#openid").val();
		var latitude=$('#latitude').val();
		var longitude=$('#longitude').val();
		$.ajax({
			url : vote_save,
			type : 'post',
			dataType : "json",
			data : {openid:openid,oid:oid,latitude:latitude,longitude:longitude,type:'0'},
			async : false,
			success : function(data) {
				if(data.success=='0'){

					$('#get_num_'+oid).html('票数：'+data.msg);

					show('投票成功！');
				}
				if(data.success=='1'){
					show('每天只能帮TA投票一次！');
				}
				if(data.success=='2'){
					show('请勿刷票！');
				}
				if(data.success=='3'){

					show('您投票机会用完了');
				}
				if(data.success=='4'){
					location.reload();
				}
				if(data.success=='5'){
					show(data.msg);
				}
				if(data.success=='9'){
                    window.location.reload();
                }
			},
			error : function(msg, error) {
				show('系统忙，请稍后！!');
			}
		});
	}
	
	//提交资料
	function set_reg(){
		var openid = $("#openid").val();
		var name = $("#name").val();
		var mobile = $("#mobile").val();
		var reg_name = new RegExp("^[\\u4e00-\\u9fa5]{2,6}$"); 
		var reg_mobile=new RegExp("^1[3,5,4,7,8]{1}[0-9]{9}$");
	    
		if(openid==''){show('系统参数错误');return;}
		if(!reg_name.test(name)){show('姓名请输入2-6个中文！');return;}
		if(!reg_mobile.test(mobile)){show("请输入正确的手机号码!");return;}
		
		$.ajax({
			url : 'libs/member_set.php',
			type : 'post',
			dataType : "json",
			data : {openid:openid,name:name,mobile:mobile},
			async : false,
			success : function(msg) {
				if(msg.s=='0'){
					$('#float_bg').hide();
					$('#float_reg').hide();
					show('提交成功，开始投票！');
				}
				if(msg.s=='1'){
					show('手机号码已经存在，请更换手机号码');
				}
			},
			error : function(msg, error) {
				show('系统忙，请稍后！');
			}
		});
	}
	
	//显示提示
	function show(str){
		$('.result').html(str);
		$('.result').show();
		setTimeout(function(){
			$('.result').hide();
		}, 2000);
	}
	
	$("#float_bg").click(function(){
		$("#float_bg").hide();
		$('#float_add').hide().animate({bottom:'0',opacity:'0'});
		$('#float_reg').hide();
	});
	
	//缩放操作
	// function set_zoom(){
	// 	$('.p').click(function (){
	// 		var img=$(this).attr("data-original");
	// 		var name=$(this).next().html();
	// 		$('.show_zoom').html('<img src="'+img+'">');
	// 		$('.title_zoom').html(name);
	// 		$('.zoom').show();
	// 		$('.pinch-zoom').each(function () {
	// 			new RTP.PinchZoom($(this), {});
	// 		});
	// 	});
	// }
	
	// $('.zoom').click(function (){
	// 	$('.zoom').hide();
	// });
	
	//var h=$(window).height();
	var h=document.body.clientHeight;
	$(".show_zoom").height(h);
	
});