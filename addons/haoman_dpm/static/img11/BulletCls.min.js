(function (d, c, a) {
    var face = {
        faceUrl: '../addons/haoman_base/dpm/face',
        arr: ["[笑哈哈]", "[得瑟]", "[得意地笑]", "[转圈]", "[挤地铁]", "[我忍了]", "[粉爱你]", "[粉红兔火车]", "[转圈圈]", "[鼓掌]", "[压力]", "[抢镜]", "[草泥马]", "[神马]", "[多云]", "[给力]", "[围观]", "[v5]", "[小熊猫]", "[粉红兔微笑]", "[动感光波]", "[囧]", "[互粉]", "[礼物]", "[微笑]", "[呲牙笑]", "[大笑]", "[羞羞]", "[小可怜]", "[抠鼻孔]", "[惊讶]", "[大眼睛羞涩]", "[吐舌头]", "[闭嘴]", "[鄙视]", "[爱你哦]", "[泪牛满面]", "[偷笑]", "[嘴一个]", "[生病]", "[装可爱]", "[切~]", "[右不屑]", "[左不屑]", "[嘘]", "[雷人]", "[呕吐]", "[委屈]", "[装可爱]", "[再见]", "[疑问]", "[困]", "[money]", "[装酷]", "[色眯眯]", "[ok]", "[good]", "[nonono]", "[赞一个]", "[弱]"],
        init: function(list) {
            var arr = this.arr;
            for (var i = 0; i < list.length; i++) {
                var val = list[i].innerHTML;
                for (var j = 0; j < arr.length; j++) {
                    while (val.indexOf(arr[j]) != -1) {
                        val = val.replace(arr[j], '<img style="width:30px;height:30px;" src="' + this.faceUrl + '/' + (j + 1) + '.png" />');

                    }
                }
                list[i].innerHTML = val;
            }
        },
        replaceText: function(val) {
            if (val != null && val != '') {
                var arr = this.arr;
                for (var i = 0; i < arr.length; i++) {
                    while (val.indexOf(arr[i]) != -1) {
                        val = val.replace(arr[i], '<img style="width:30px;height:30px;" src="' + this.faceUrl + '/' + (i + 1) + '.png" />');
                    }
                }
            }
            return val;
        }
    }
    function cutstr(str,len){
        var str_length = 0;
        var str_len = 0;
        str_cut = new String();
        str_len = str.length;
        for(var i = 0;i<str_len;i++)
        {
            a = str.charAt(i);
            str_length++;
            if(escape(a).length > 4)
            {
                //中文字符的长度经编码之后大于4
                str_length++;
            }
            str_cut = str_cut.concat(a);
            if(str_length>=len)
            {
                str_cut = str_cut.concat("...");
                return str_cut;
            }
        }
        //如果给定字符串小于指定长度，则返回源字符串；
        if(str_length<len){
            return  str;
        }
    }
    function b(f, l, h) {
        var k = this;
        k.box = l;
        k.box1 = h;
        k.container = f;
        k.clientWidth = $(window).width();
        k.clientHeight = document.body.clientHeight;
        k.data = [];
        k.isBullet = true;
        var m = Math.ceil((k.clientHeight - 180) / 100);

        k.yPos = [];
        for (var j = 0; j < m; j++) {
            k.yPos.push(j + 1)
        }
        var g = setInterval(function () {

            if (k.data.length > 0 && k.yPos.length > 0) {
                k.createBulletMsg(k.data.shift())
            }
        }, 1000)
    }

    var e = b.prototype;
    e.createBulletMsg = function (l) {

        var j = this;
        var h = l.style ? j.box1.clone() : j.box.clone();
        j.renderUI(h, l);
        h.css("left", j.clientWidth);

        var i = j.yPos.splice(Utility.getRandom(0, j.yPos.length), 1);

        i = i[0];

        var k = i * 60 - 50;
        j.container.append(h);
        var g = h.width();
        h.css({top: k});

        if (l.style) {
            var f = function () {
                h.transition({
                    x: -(j.clientWidth + g + 150), duration: 10000, easing: "linear", complete: function () {
                        h.remove();
                        j.yPos.push(i)
                    }
                })
            };
            h.transition({
                x: -j.clientWidth / 2 - g / 2, duration: 10000, easing: "linear", complete: function () {
                    setTimeout(f, l.time * 1000)
                }
            })
        } else {
            h.transition({
                x: -(j.clientWidth + g),
                duration: 8000 + Utility.getRandom(1, 10) * 1000,
                easing: "linear",
                complete: function () {
                    h.remove();
                    j.yPos.push(i)
                }
            })
        }
    };
    e.close = function () {
        var f = this;
        f.isBullet = false;
        f.container.find(".bullet-box").each(function () {
            d(this).css("visibility", "hidden")
        })
    };
    e.open = function () {
        var f = this;
        f.isBullet = true;
        f.container.find(".bullet-box").each(function () {
            d(this).css("visibility", "visible")
        })
    };
    e.changeStatus = function () {
        if (this.isBullet == true) {
            this.close()
        } else {
            this.open()
        }
    };
    e.renderUI = function (f, g) {
        if (g.head_img != "") {
            f.find("img:first").attr("src", g.head_img)
        }
        if (g.b_wordimg != "") {
            if(g.type==4){
                f.find(".wordimg img").hide();
                f.find(".wordimg video").show();
                f.find(".wordimg video").attr("src", g.b_wordimg)
            }else{
                f.find(".wordimg img").attr("src", g.b_wordimg)
            }
            f.find(".wordimg").show();

        }
        if (g.style) {
            if (g.nickname != "") {
                f.find(".reward-word-max").text(g.nickname)
            }
            if (g.txt != "") {
                if(g.type==2){
                    //礼物
                    f.find(".money-txt").html('打赏给:'+face.replaceText(cutstr(g.txt,400)))
                }
                else{
                    f.find(".money-txt").html(face.replaceText(cutstr(g.txt,400)))
                }

            }
        } else {
            if (g.nickname != "") {
                f.find(".bullet-name").text(g.nickname)
            }
            if (g.txt != "") {
                if(g.type==2){
                    //礼物
                    f.find(".bullet-msg").html('打赏给:'+face.replaceText(cutstr(g.txt,400)))
                }
                else{
                    if(g.type==3){
                        f.find(".bullet-msg").html(face.replaceText(cutstr(g.txt,400)))
                    }
                    else {
                        f.find(".bullet-msg").html(face.replaceText(cutstr(g.txt,400)))
                    }

                }
                // f.find(".bullet-msg").html(face.replaceText(cutstr(g.txt,400)))
            }
        }
    };
    e.addBullet = function (f) {

        if (this.isBullet == true) {
            f.style == 0 ? this.data.unshift(f) : this.data.push(f)
        }
    };
    e.refreshBullet = function (f) {

        if (f.hasOwnProperty("action") && f.action == "bullet_status") {

            if (f.status == 1) {
                this.open()
            } else {
                this.close()
            }
        } else {
            this.addBullet({
                style: f.style ? f.style : 0,
                head_img: f.head_img,
                nickname: f.nickname,
                txt: f.txt,
                time: f.time,
                b_wordimg: f.b_wordimg,
                type: f.b_type
            })
        }
    };
    e.resize = function () {
        this.clientWidth = a.documentElement.clientWidth
    };

        c.BulletCls = b


}(jQuery, window, document));