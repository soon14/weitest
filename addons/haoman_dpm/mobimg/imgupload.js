window.URL=window.URL||window.webkitURL;function imgPreview(f,d,c){var e=d.files,b=new Image();if(window.URL){b.src=window.URL.createObjectURL(e[0]);b.onload=function(g){var h=this.src;f.attr("src",h);window.URL.revokeObjectURL(this.src);getImageCompressedData(b,c,function(){f.parents(".imgField").remove();d.value="";$("#upload").removeClass("disabled");alert("图片上传失败")})};b.onerror=function(g){f.parents(".imgField").remove();d.value="";$("#upload").removeClass("disabled");alert("图片错误或损坏")}}else{if(window.FileReader){var a=new FileReader();a.readAsDataURL(e[0]);a.onload=function(g){f.error(function(){$(this).parents(".imgField").remove();d.value="";$("#upload").removeClass("disabled");alert("图片错误或损坏")});f.attr("src",this.result);getImageCompressedData(b,c,function(){f.parents(".imgField").remove();d.value="";$("#upload").removeClass("disabled");alert("图片上传失败")})}}}}function getImageCompressedData(a,c,g){var d=a.width;var b=false;if(d>=640){b=true}try{handleImgBase64(0,compress(a,b),c,g)}catch(f){console.log(f)}}function handleImgBase64(f,b,d,g){if(b.indexOf("base64")>0){b=b.substring(b.indexOf("base64")+7)}var c=window.uploadBasePath+new Date().getTime()+Math.round(Math.random()*100000)+".jpg";var a="http://upload.qiniu.com/putb64/-1/key/"+base64encode(c);var e=new XMLHttpRequest();e.onreadystatechange=function(){if(e.readyState==4){$("#cover").hide();$("#loading").hide();if(e.status==200||e.status==304||e.status==0){d&&d(c)}else{f++;if(f<=2){handleImgBase64(f,b,g);return}g()}}};e.open("POST",a,true);e.setRequestHeader("Content-Type","application/octet-stream");e.setRequestHeader("Authorization","UpToken "+window.qiniuUpToken);e.send(b);$.ajax({url:"/mobile/getQiniuToken",type:"get",dataType:"json",beforeSend:function(){},complete:function(){},success:function(h){if(h.success){window.qiniuUpToken=h.model.token}}})}function compress(b,c,d){var g="image/jpeg";if(d=="png"){g="image/png"}var e=document.createElement("canvas");var f=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);var i;if(c){if(f){var h=new MegaPixImage(b);h.render(e,{maxWidth:460,maxHeight:460})}else{var a=460;if(b.width>b.height){e.width=a;e.height=b.height*a/b.width}else{e.width=b.width*a/b.height;e.height=a}e.getContext("2d").drawImage(b,0,0,e.width,e.height)}i=e.toDataURL(g,1)}else{if(f){var h=new MegaPixImage(b);h.render(e,{maxWidth:b.width,maxHeight:b.height})}else{e.width=b.width;e.height=b.height;e.getContext("2d").drawImage(b,0,0,e.width,e.height)}i=e.toDataURL(g,1)}return i}var base64EncodeChars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";function base64encode(g){var c,e,a;var f,d,b;a=g.length;e=0;c="";while(e<a){f=g.charCodeAt(e++)&255;if(e==a){c+=base64EncodeChars.charAt(f>>2);c+=base64EncodeChars.charAt((f&3)<<4);c+="==";break}d=g.charCodeAt(e++);if(e==a){c+=base64EncodeChars.charAt(f>>2);c+=base64EncodeChars.charAt(((f&3)<<4)|((d&240)>>4));c+=base64EncodeChars.charAt((d&15)<<2);c+="=";break}b=g.charCodeAt(e++);c+=base64EncodeChars.charAt(f>>2);c+=base64EncodeChars.charAt(((f&3)<<4)|((d&240)>>4));c+=base64EncodeChars.charAt(((d&15)<<2)|((b&192)>>6));c+=base64EncodeChars.charAt(b&63)}return c};